<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Byg-selv Lydplanlægger</title>
  <style>
    :root{
      --ls-green-1:#0B6623;
      --ls-green-2:#1E7A2E;
      --ls-green-3:#2FA84F;
      --ls-green-4:#5FCF73;
      --ls-green-5:#7AD37A;
      --ls-green-6:#A4E1A6;
      --ls-green-7:#CDECCB;
    }
    html,body{margin:0;height:100%;font-family:Arial,sans-serif;}
    body{display:flex;flex-direction:column;}
    .ls-topbar{display:flex;align-items:center;padding:8px 12px;background:var(--ls-green-1);color:#fff;gap:8px;font-size:14px;}
    .ls-topbar input,.ls-topbar select,.ls-topbar button{margin-right:8px;}
    .ls-main{flex:1;display:flex;}
    .ls-left{width:180px;background:var(--ls-green-6);padding:8px;font-size:14px;}
    .ls-left ul{list-style:none;padding:0;margin:8px 0 0;}
    .ls-left li{margin-bottom:4px;cursor:pointer;padding:4px;}
    .ls-left li.active{background:var(--ls-green-7);}
    .ls-canvas-container{flex:1;position:relative;background:#fff;}
    #ls-canvas{width:100%;height:100%;background-size:25px 25px;background-image:linear-gradient(0deg,var(--ls-green-7) 1px,transparent 1px),linear-gradient(90deg,var(--ls-green-7) 1px,transparent 1px);}
    .ls-right{width:260px;background:var(--ls-green-6);display:flex;flex-direction:column;}
    .ls-products,.ls-cart{padding:8px;flex:1;overflow:auto;font-size:14px;}
    .ls-tabs{display:flex;gap:4px;margin-bottom:8px;}
    .ls-tabs button{flex:1;padding:6px;border:none;background:var(--ls-green-3);color:#fff;cursor:pointer;}
    .ls-product-list{list-style:none;padding:0;margin:0;}
    .ls-product-list li{margin-bottom:4px;padding:4px;background:var(--ls-green-7);cursor:pointer;}
    .ls-cart h3,.ls-products h3{margin-top:0;}
    .ls-legend{list-style:none;margin:8px 0 0;padding:0;display:grid;grid-template-columns:repeat(2,1fr);gap:4px;font-size:12px;}
    .ls-legend span{display:inline-block;width:20px;height:12px;margin-right:4px;vertical-align:middle;}
    .ls-cta{padding:8px;display:flex;flex-direction:column;gap:8px;}
    .ls-cta button{padding:10px;background:var(--ls-green-2);color:#fff;border:none;border-radius:4px;cursor:pointer;}
    .ls-onboarding{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:12px;border:1px solid var(--ls-green-3);font-size:14px;}
  </style>
</head>
<body>
  <div class="ls-topbar">
    <select>
      <option>Indendørs</option>
      <option>Udendørs</option>
    </select>
    <input type="number" placeholder="Gæster" />
    <input id="dimension-input" type="text" placeholder="Længde × Bredde (m)" value="20×20" />
    <button>Undo</button>
    <button>Redo</button>
    <label><input id="heatmap-toggle" type="checkbox" checked /> Heatmap</label>
  </div>
  <div class="ls-main">
    <aside class="ls-left">
      <h3>Tegneværktøjer</h3>
      <ul>
        <li data-tool="rect">Rektangel</li>
        <li data-tool="poly">Polygon</li>
        <li>Væg/Scene/Bord</li>
        <li>Målebånd</li>
      </ul>
    </aside>
    <div class="ls-canvas-container">
      <canvas id="ls-canvas"></canvas>
      <div class="ls-onboarding">1. Tegn området → 2. Placer højttalere → 3. Tjek dækningen</div>
    </div>
    <aside class="ls-right">
      <div class="ls-products">
        <h3>Produkter</h3>
        <div class="ls-tabs">
          <button>Højttalere</button>
          <button>Subwoofere</button>
        </div>
        <ul class="ls-product-list">
          <li>Yamaha DXR12</li>
          <li>Yamaha DXS12 MKII</li>
          <li>dB Technologies B-Hype 12</li>
        </ul>
      </div>
      <div class="ls-cart">
        <h3>Kurv</h3>
        <p>Ingen produkter</p>
        <h4>Total: 0 DKK</h4>
        <ul class="ls-legend">
          <li><span style="background:#0B6623"></span> ≤84 dB</li>
          <li><span style="background:#1E7A2E"></span> 86 dB</li>
          <li><span style="background:#2FA84F"></span> 88 dB</li>
          <li><span style="background:#5FCF73"></span> 91 dB</li>
          <li><span style="background:#7AD37A"></span> 94 dB</li>
          <li><span style="background:#A4E1A6"></span> 97 dB</li>
          <li><span style="background:#CDECCB"></span> ≥100 dB</li>
        </ul>
      </div>
      <div class="ls-cta">
        <button>Gem projekt</button>
        <button>Send forespørgsel</button>
      </div>
    </aside>
  </div>
  <script type="module">
    import {PRODUCTS_SEED} from './PRODUCTS_SEED.js';
    import {calcCoverageGrid} from './utils/coverageGrid.js';

    const CELL_PX = 25; // 1m grid cell
    const area = {w:20, h:20};
    const canvas = document.getElementById('ls-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = area.w * CELL_PX;
    canvas.height = area.h * CELL_PX;

    const speakers = [];
    const shapes = [];
    let tool = null;
    let drawingRect = null;
    let currentPolygon = null;
    let cursorPos = null;
    let showHeatmap = true;

    const heatmapToggle = document.getElementById('heatmap-toggle');
    heatmapToggle.addEventListener('change', () => {
      showHeatmap = heatmapToggle.checked;
      render();
    });

    const dimensionInput = document.getElementById('dimension-input');
    dimensionInput.addEventListener('change', () => {
      const match = dimensionInput.value.match(/\s*(\d+(?:\.\d+)?)\s*[x×]\s*(\d+(?:\.\d+)?)/i);
      if(match){
        area.w = parseFloat(match[1]);
        area.h = parseFloat(match[2]);
        canvas.width = area.w * CELL_PX;
        canvas.height = area.h * CELL_PX;
        render();
      }
    });

    function hexToRgba(hex, alpha){
      const int = parseInt(hex.slice(1),16);
      const r=(int>>16)&255, g=(int>>8)&255, b=int&255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function drawRect(rect, preview=false){
      ctx.save();
      ctx.strokeStyle = '#000';
      ctx.fillStyle = preview ? 'rgba(0,0,255,0.1)' : 'rgba(0,0,0,0.2)';
      ctx.beginPath();
      ctx.rect(rect.x*CELL_PX, rect.y*CELL_PX, rect.w*CELL_PX, rect.h*CELL_PX);
      ctx.fill();
      ctx.stroke();
      ctx.restore();
    }

    function drawPoly(points, preview=false){
      if(points.length < 2) return;
      ctx.save();
      ctx.strokeStyle = '#000';
      ctx.fillStyle = preview ? 'rgba(0,0,255,0.1)' : 'rgba(0,0,0,0.2)';
      ctx.beginPath();
      ctx.moveTo(points[0].x*CELL_PX, points[0].y*CELL_PX);
      for(let i=1;i<points.length;i++){
        ctx.lineTo(points[i].x*CELL_PX, points[i].y*CELL_PX);
      }
      if(!preview && points.length>2){
        ctx.closePath();
        ctx.fill();
      }
      ctx.stroke();
      ctx.restore();
    }

    function render(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(showHeatmap){
        const grid = calcCoverageGrid({widthM:area.w,heightM:area.h,cellSizeM:1,speakers});
        grid.data.forEach((row,y)=>{
          row.forEach((cell,x)=>{
            if(cell.color.alpha>0){
              ctx.fillStyle = hexToRgba(cell.color.hex, cell.color.alpha);
              ctx.fillRect(x*CELL_PX, y*CELL_PX, CELL_PX, CELL_PX);
            }
          });
        });
      }
      // draw shapes
      shapes.forEach(shape=>{
        if(shape.type==='rect') drawRect(shape);
        if(shape.type==='poly') drawPoly(shape.points);
      });
      // draw previews
      if(drawingRect){
        const rect = {
          x: Math.min(drawingRect.xStart, drawingRect.xEnd),
          y: Math.min(drawingRect.yStart, drawingRect.yEnd),
          w: Math.abs(drawingRect.xEnd - drawingRect.xStart),
          h: Math.abs(drawingRect.yEnd - drawingRect.yStart)
        };
        drawRect(rect, true);
      }
      if(currentPolygon){
        const pts = cursorPos ? [...currentPolygon, cursorPos] : currentPolygon;
        drawPoly(pts, true);
      }
      // draw speakers
      speakers.forEach(sp=>{
        ctx.save();
        ctx.translate(sp.x*CELL_PX, sp.y*CELL_PX);
        ctx.rotate(sp.rotDeg*Math.PI/180);
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.lineTo(-5,10);
        ctx.lineTo(5,10);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      });
    }

    // select drawing tool
    document.querySelectorAll('.ls-left li[data-tool]').forEach(li=>{
      li.addEventListener('click', ()=>{
        tool = li.dataset.tool;
        document.querySelectorAll('.ls-left li').forEach(el=>el.classList.toggle('active', el===li));
      });
    });

    // Add speaker by clicking product
    document.querySelectorAll('.ls-product-list li').forEach((li,idx)=>{
      li.addEventListener('click', ()=>{
        const prod = PRODUCTS_SEED[idx];
        speakers.push({x:area.w/2,y:area.h/2,rotDeg:0,productId:prod.id});
        render();
      });
    });

    // canvas interactions
    let dragIdx = null;
    canvas.addEventListener('mousedown', e=>{
      const x = e.offsetX / CELL_PX;
      const y = e.offsetY / CELL_PX;
      if(tool === 'rect'){
        drawingRect = {xStart:x, yStart:y, xEnd:x, yEnd:y};
      }else if(tool === 'poly'){
        if(!currentPolygon){
          currentPolygon = [{x,y}];
        }else{
          currentPolygon.push({x,y});
        }
      }else{
        dragIdx = speakers.findIndex(sp=>Math.hypot(sp.x-x, sp.y-y) < 0.5);
      }
    });

    canvas.addEventListener('mousemove', e=>{
      const x = e.offsetX / CELL_PX;
      const y = e.offsetY / CELL_PX;
      if(drawingRect){
        drawingRect.xEnd = x;
        drawingRect.yEnd = y;
        render();
      }else if(currentPolygon){
        cursorPos = {x,y};
        render();
      }else if(dragIdx!==null){
        speakers[dragIdx].x = x;
        speakers[dragIdx].y = y;
        render();
      }
    });

    canvas.addEventListener('mouseup', ()=>{
      if(drawingRect){
        const rect = {
          x: Math.min(drawingRect.xStart, drawingRect.xEnd),
          y: Math.min(drawingRect.yStart, drawingRect.yEnd),
          w: Math.abs(drawingRect.xEnd - drawingRect.xStart),
          h: Math.abs(drawingRect.yEnd - drawingRect.yStart)
        };
        shapes.push({type:'rect', ...rect});
        drawingRect = null;
        render();
      }
      dragIdx = null;
    });

    canvas.addEventListener('mouseleave', ()=>{
      if(drawingRect){
        drawingRect = null;
        render();
      }
      dragIdx = null;
    });

    canvas.addEventListener('dblclick', ()=>{
      if(tool === 'poly' && currentPolygon){
        if(currentPolygon.length >= 2){
          shapes.push({type:'poly', points: currentPolygon});
        }
        currentPolygon = null;
        cursorPos = null;
        render();
      }
    });

    canvas.addEventListener('contextmenu', e=>{
      e.preventDefault();
      const x = e.offsetX / CELL_PX;
      const y = e.offsetY / CELL_PX;
      if(tool === 'poly' && currentPolygon){
        if(currentPolygon.length >= 2){
          shapes.push({type:'poly', points: currentPolygon});
        }
        currentPolygon = null;
        cursorPos = null;
        render();
      }else{
        const sp = speakers.find(sp=>Math.hypot(sp.x-x, sp.y-y) < 0.5);
        if(sp){ sp.rotDeg = (sp.rotDeg + 15) % 360; render(); }
      }
    });

    render();
  </script>
</body>
</html>
